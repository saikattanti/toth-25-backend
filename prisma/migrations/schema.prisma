generator client {
  provider = "prisma-client-js"
}

// prisma/schema.prisma
datasource db {
  provider  = "postgresql"
  url  	    = env("DATABASE_URL")
  // uncomment next line if you use Prisma <5.10
  // directUrl = env("DATABASE_URL_UNPOOLED")
}

model User {
  id            Int         @id @default(autoincrement())
  fullName      String
  email         String      @unique
  password      String
  phoneNumber   String?     @unique
  department    String?
  deptRollNo    String?
  emailVerified Boolean     @default(false)
  otpHash       String?
  otpExpiresAt  DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Relations
  emailAuths    EmailAuth[]
  createdRiddles Riddle[]   @relation("CreatedBy")
  updatedRiddles Riddle[]   @relation("UpdatedBy")
  scans         Scan[]      @relation("ScannedBy")
}

model EmailAuth {
  id        Int      @id @default(autoincrement())
  userId    Int
  email     String
  otpHash   String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([email])
}

model Riddle {
  id            Int      @id @default(autoincrement())
  name          String
  riddle        String   @db.Text
  hint          String   @db.Text
  encryptedData String   @db.Text
  createdAt     DateTime @default(now())
  createdBy     Int
  updatedAt     DateTime @updatedAt
  updatedBy     Int
  
  // Relations
  creator       User     @relation("CreatedBy", fields: [createdBy], references: [id], onDelete: Cascade)
  updater       User     @relation("UpdatedBy", fields: [updatedBy], references: [id], onDelete: Cascade)
  scans         Scan[]   @relation("RiddleScans")
  
  @@index([createdBy])
  @@index([updatedBy])
}

model Scan {
  id              Int      @id @default(autoincrement())
  scannedByUserId Int
  riddleId        Int
  riddleHint      String   @db.Text
  createdAt       DateTime @default(now())
  
  // Relations
  scannedBy       User     @relation("ScannedBy", fields: [scannedByUserId], references: [id], onDelete: Cascade)
  riddle          Riddle   @relation("RiddleScans", fields: [riddleId], references: [id], onDelete: Cascade)
  
  @@index([scannedByUserId])
  @@index([riddleId])
  @@unique([scannedByUserId, riddleId]) // Prevent duplicate scans
}